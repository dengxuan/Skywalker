// Licensed to the Gordon under one or more agreements.
// Gordon licenses this file to you under the MIT license.

using System.Text;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;

namespace Skywalker.Ddd.Domain.Generators;

public partial class DddDomainGenerator
{
    internal class Emitter
    {
        private const int DefaultStringBuilderCapacity = 1024;
        private static readonly string s_generatedCodeAttribute = @$"[System.CodeDom.Compiler.GeneratedCodeAttribute(""{typeof(Emitter).Assembly.GetName().Name}"", ""{typeof(Emitter).Assembly.GetName().Version}"")]";


        public static void Emit(GeneratorExecutionContext context, IReadOnlyList<DbContextClass> dbContextClasses)
        {
            var builder = new StringBuilder(DefaultStringBuilderCapacity);
            builder.Clear();
            builder.AppendLine("// <auto-generated>");
            builder.AppendLine("//     Generated by the Skywalker.Ddd.EntityFrameworkCore.Generators");
            builder.AppendLine("// </auto-generated>");
            builder.AppendLine();
            builder.AppendLine($"using Microsoft.Extensions.DependencyInjection.Extensions;");
            builder.AppendLine($"using Skywalker.Ddd.Domain.Repositories;");
            builder.AppendLine($"using Skywalker.Ddd.EntityFrameworkCore.Repositories;");
            builder.AppendLine();
            builder.AppendLine("#nullable enable");
            builder.AppendLine();
            builder.AppendLine($"namespace Microsoft.Extensions.DependencyInjection;");
            builder.AppendLine();
            builder.AppendLine($"{s_generatedCodeAttribute}");
            builder.AppendLine("public static class EntityFrameworkCoreIServiceCollectionExtensions");
            builder.AppendLine("{");

            var keyValuePairs = dbContextClasses.ToDictionary(keySelector => keySelector, elementSelector => elementSelector.Properties);
            foreach (var item in keyValuePairs)
            {
                builder.AppendLine($"\tpublic static SkywalkerDbContextBuilder Add{ item.Key.Name }Factory(this SkywalkerDbContextBuilder builder)");
                builder.AppendLine("\t{");
                builder.AppendLine($"\t\tbuilder.AddDbContextFactory<{ item.Key.Fullname }>();");
                builder.AppendLine($"\t\tbuilder.Add{ item.Key.Name }Repisitories();");
                builder.AppendLine("\t\treturn builder;");
                builder.AppendLine("\t}");
                builder.AppendLine();
                builder.AppendLine($"\tpublic static SkywalkerDbContextBuilder Add{ item.Key.Name }(this SkywalkerDbContextBuilder builder)");
                builder.AppendLine("\t{");
                builder.AppendLine($"\t\tbuilder.AddDbContext<{ item.Key.Fullname }>();");
                builder.AppendLine($"\t\tbuilder.Add{ item.Key.Name }Repisitories();");
                builder.AppendLine("\t\treturn builder;");
                builder.AppendLine("\t}");
                builder.AppendLine();
                builder.AppendLine($"\tinternal static SkywalkerDbContextBuilder Add{ item.Key.Name }Repisitories(this SkywalkerDbContextBuilder builder)");
                builder.AppendLine("\t{");
                foreach (var dbContextProperty in item.Value)
                {
                    builder.AppendLine($"\t\tbuilder.Services.TryAddTransient<IRepository<{ dbContextProperty.Fullname }>, Repository<{ item.Key.Fullname }, { dbContextProperty.Fullname }>>();");
                    builder.AppendLine($"\t\tbuilder.Services.TryAddTransient<IBasicRepository<{ dbContextProperty.Fullname }>, Repository<{ item.Key.Fullname }, { dbContextProperty.Fullname }>>();");
                    builder.AppendLine($"\t\tbuilder.Services.TryAddTransient<IReadOnlyRepository<{ dbContextProperty.Fullname }>, Repository<{ item.Key.Fullname }, { dbContextProperty.Fullname }>>();");
                    if (!string.IsNullOrEmpty(dbContextProperty.PrimaryKey))
                    {
                        builder.AppendLine($"\t\tbuilder.Services.TryAddTransient<IRepository<{ dbContextProperty.Fullname }, { dbContextProperty.PrimaryKey }>, Repository<{ item.Key.Fullname }, { dbContextProperty.Fullname }, { dbContextProperty.PrimaryKey }>>();");
                        builder.AppendLine($"\t\tbuilder.Services.TryAddTransient<IBasicRepository<{ dbContextProperty.Fullname }, { dbContextProperty.PrimaryKey }>, Repository<{ item.Key.Fullname }, { dbContextProperty.Fullname }, { dbContextProperty.PrimaryKey }>>();");
                        builder.AppendLine($"\t\tbuilder.Services.TryAddTransient<IReadOnlyRepository<{ dbContextProperty.Fullname }, { dbContextProperty.PrimaryKey }>, Repository<{ item.Key.Fullname }, { dbContextProperty.Fullname }, { dbContextProperty.PrimaryKey }>>();");
                    }
                    builder.AppendLine();
                }
                builder.AppendLine("\t\treturn builder;");
                builder.AppendLine("\t}");
            }
            builder.AppendLine("}");

            context.AddSource("Skywalker.Ddd.EntityFrameworkCore.g.cs", SourceText.From(builder.ToString(), Encoding.UTF8));
        }

        public static void Emit(GeneratorExecutionContext context, IReadOnlyList<DomainServiceClass> domainServiceClasses)
        {
            var builder = new StringBuilder(DefaultStringBuilderCapacity);
            builder.Clear();
            builder.AppendLine("// <auto-generated>");
            builder.AppendLine("//     Generated by the Skywalker.Ddd.EntityFrameworkCore.Generators");
            builder.AppendLine("// </auto-generated>");
            builder.AppendLine();
            builder.AppendLine($"using Microsoft.Extensions.DependencyInjection.Extensions;");
            builder.AppendLine();
            builder.AppendLine("#nullable enable");
            builder.AppendLine();
            builder.AppendLine($"namespace Microsoft.Extensions.DependencyInjection;");
            builder.AppendLine();
            builder.AppendLine($"{s_generatedCodeAttribute}");
            builder.AppendLine("public static class DomainIServiceCollectionRepositoryExtensions");
            builder.AppendLine("{");
            builder.AppendLine();
            builder.AppendLine($"\tpublic static DomainServiceBuilder AddGeneralDomainServices(this DomainServiceBuilder builder)");
            builder.AppendLine("\t{");
            foreach (var domainServiceClass in domainServiceClasses)
            {
                foreach (var implInterface in domainServiceClass.ImplInterfaces)
                {
                    builder.AppendLine($"\t\tbuilder.Services.TryAddTransient<{ implInterface.Fullname }, {domainServiceClass.Fullname}>();");
                }
            }
            builder.AppendLine("\t\treturn builder;");
            builder.AppendLine("\t}");
            builder.AppendLine("}");
            context.AddSource("Skywalker.Ddd.DomainServices.g.cs", SourceText.From(builder.ToString(), Encoding.UTF8));
        }
    }
}
